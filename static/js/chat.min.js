function displayingMessage(){var roomName=[roomName1,roomName2],fromChatId="{{ request.user.username }}",toChatId="{{ user.username }}";for(i=0;i<roomName.length;i++){var chatSocket=new ReconnectingWebSocket("ws://"+window.location.host+"/ws/chat/"+roomName[i]+"/");function fetchMessages(){chatSocket.send(JSON.stringify({command:"fetch_messages"}))}chatSocket.onopen=function(e){fetchMessages()},chatSocket.onmessage=function(e){var data=JSON.parse(e.data);if("messages"===data.command)for(let i=0;i<data.messages.length;i++)createMessage(data.messages[i]);else"new_message"===data.command&&createMessage(data.message)},document.querySelector("#chat-message-input").focus(),document.querySelector("#chat-message-input").onkeyup=function(e){13===e.keyCode&&document.querySelector("#chat-message-submit").click()},document.querySelector("#chat-message-submit").onclick=function(e){var messageInputDom=document.querySelector("#chat-message-input"),message=messageInputDom.value;chatSocket.send(JSON.stringify({command:"new_message",message:message,fromSender:fromChatId,toRecipient:toChatId})),messageInputDom.value=""}}function createMessage(data){var sender=data.sender,msgListTag=document.createElement("li"),imgTag=document.createElement("img"),pTag=document.createElement("p");pTag.textContent=data.message,imgTag.className="circle",sender===fromChatId?(msgListTag.className="sent",imgTag.src="{{ request.user.photo.url }}"):(msgListTag.className="replies",imgTag.src="{{ user.photo.url }}"),msgListTag.appendChild(imgTag),msgListTag.appendChild(pTag),document.querySelector("#messages").appendChild(msgListTag)}}function displayingForm(){$("#current_user_data").empty(),$("#"+id).clone().appendTo("#current_user_data"),$("#box, .title").show(),document.getElementById(id).parentNode.hash===window.location.hash&&(space=hash.indexOf("_"),roomName1=hash.slice(2,-1),roomName2=hash.slice(space+1,-1)+hash.slice(space,space+1)+hash.slice(2,space),recipient=hash.slice(space+1,-1),console.log("displayingFrom",roomName1,roomName2)),displayingMessage()}function selectingForm(){$("#to_user .row a").click((function(event){id=event.target.id,document.getElementById(id).parentNode.hash!=window.location.hash&&(space=this.hash.indexOf("_"),roomName1=this.hash.slice(2,-1),roomName2=this.hash.slice(space+1,-1)+this.hash.slice(space,space+1)+this.hash.slice(2,space),recipient=this.hash.slice(space+1,-1),console.log("selectingForm",roomName1,roomName2),$("#messages li").remove(),displayingForm())}))}hash=window.location.hash,hash===window.location.hash&&""!=hash?(console.log("Есть хэштег"),start=hash.indexOf("_")+1,hash_username=hash.slice(start,-1),id="to_"+hash_username+"_data",displayingForm(),selectingForm()):(console.log("Хэштега нет"),selectingForm());