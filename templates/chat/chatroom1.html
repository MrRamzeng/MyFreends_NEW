<!DOCTYPE html>
{% load static %}
<html>

<head>
    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet'
        type='text/css'>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="//use.typekit.net/hoy3lrg.js"></script>
    <script>try { Typekit.load({ async: true }); } catch (e) { }</script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
    <link rel="stylesheet" href="{% static 'css/chatroom.css' %}">
</head>

<body>
    <div id="frame">
        <div id="sidepanel">
            <div id="profile">
                <div class="wrap">
                    <img id="profile-img" src="{{ request.user.photo.url }}" class="online">
                    <p>{{ request.user.first_name }} {{request.user.last_name }}</p>
                    <i class="fa fa-chevron-down expand-button" aria-hidden="true"></i>
                    <div id="status-options">
                        <ul>
                            <li id="status-online" class="active"><span class="status-circle"></span>
                                <p>Online</p>
                            </li>

                            <li id="status-away"><span class="status-circle"></span>
                                <p>Away</p>
                            </li>

                            <li id="status-busy"><span class="status-circle"></span>
                                <p>Busy</p>
                            </li>

                            <li id="status-offline"><span class="status-circle"></span>
                                <p>Offline</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="contacts">
                <ul>
                    {% for account in users %}
                    <li class="contact">
                        <a href="{% url 'chatroom' User=request.user.username username=account.username %}">
                            <div class="wrap">
                                <img class="online" src="{{ account.photo.url }}">
                                <div class="meta">
                                    <p class="name">{{ account.first_name }} {{ account.last_name }}</p>
                                    <p class="preview">
                                        {% if from_last_message.published > to_last_message.published %}
                                        
                                        {% if from_last_message.sender == request.user %}
                                        Я: {{ from_last_message.message }}
                                        {% else %}
                                        {{ user.first_name }}: {{ from_last_message.message }}
                                        {% endif %}
                                            
                                        {% else %}
                                        
                                        {% if to_last_message.sender == request.user %}
                                        Я: {{ to_last_message.message }}
                                        {% else %}
                                        {{ user.first_name }}: {{ to_last_message.message }}
                                        {% endif %}

                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div id="bottom-bar">
                <button id="addcontact"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add
                        contact</span></button>
                <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>
            </div>
        </div>

        <div id="scroll" class="content">
            <div class="contact-profile">
                <img src="{{ user.photo.url }}">
                <p>{{ user.first_name }} {{ user.last_name }}</p>
            </div>

            <div id="scroll" class="messages">
                <ul id="messages">
                </ul>
            </div>

            <div class="message-input">
                <div class="wrap">
                    <input id="chat-message-input" type="text" placeholder="Write your message..." >
                    <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
                    <button id="chat-message-submit" class="submit">
                        <i class="fa fa-paper-plane" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/reconnecting-websocket.js' %}"></script>
    <script>
        var roomName = [{{ room_name_json }}, {{ room_name_json2 }}];
        var fromChatId = '{{ request.user.username }}';
        var toChatId = '{{ user.username }}';

        for (i = 0; i < roomName.length; i++) {
            var chatSocket = new ReconnectingWebSocket(
                'ws://' + window.location.host +
                '/ws/chat/' + roomName[i] + '/');
            chatSocket.onopen = function (e) {
                fetchMessages();
            }

            chatSocket.onmessage = function (e) {
                var data = JSON.parse(e.data);
                if (data['command'] === 'messages') {
                    for (let i = 0; i < data['messages'].length; i++) {
                        createMessage(data['messages'][i]);
                    }
                } else if (data['command'] === 'new_message') {
                    createMessage(data['message']);
                }
            }

            chatSocket.onclose = function (e) {
                console.error('Chat socket closed unexpectedly');
            };

            document.querySelector('#chat-message-input').focus();

            document.querySelector('#chat-message-input').onkeyup = function (e) {
                if (e.keyCode === 13) {  // enter, return
                    document.querySelector('#chat-message-submit').click();
                }
            };

            document.querySelector('#chat-message-submit').onclick = function (e) {
                var messageInputDom = document.querySelector('#chat-message-input');
                var message = messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'command': 'new_message',
                    'message': message,
                    'fromSender': fromChatId,
                    'toRecipient': toChatId
                }));
                messageInputDom.value = '';
            };

            function fetchMessages() {
                chatSocket.send(JSON.stringify({ 'command': 'fetch_messages' }));
            }
        }

        function createMessage(data) {
            var sender = data['sender'];
            var msgListTag = document.createElement('li');
            var imgTag = document.createElement('img');
            var pTag = document.createElement('p');
            pTag.textContent = data.message;
            imgTag.className = 'circle';
            if (sender === fromChatId) {
                msgListTag.className = 'sent';
                imgTag.src = '{{ request.user.photo.url }}';
            } else {
                msgListTag.className = 'replies';
                imgTag.src = '{{ user.photo.url }}';
            }
            msgListTag.appendChild(imgTag);
            msgListTag.appendChild(pTag);
            document.querySelector('#messages').appendChild(msgListTag);
            document.getElementById('scroll').scrollTop = 9999;
        }

        document.getElementById('scroll').scrollTop = 9999;
    </script>

</body>

</html>